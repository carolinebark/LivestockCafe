---
title: "LiveSockCafe_location"
author: "Caroline Bark"
date: "2024-02-21"
output: html_document

---
```{r setup,echo=FALSE}
knitr::opts_chunk$set(
  fig.pos = "H"
)

knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
```

```{r libraries, paged.print=FALSE}

library(ggplot2)
library(dplyr)
library(leaflet)
library(webshot)
library(viridis)
library(kableExtra)
library(knitr)
library(readr)
library(MASS)
library(gridExtra)
library(ggridges)
library(RColorBrewer)
library(hrbrthemes)
library(ggthemes)
library(tibble)
library(treemapify)
library(stringr)
library(prettydoc)
library(data.table)
library(forcats)
library(tidyr)
library(gstat)
library(sp)
library(lme4)
library(tidyr)
library(RColorBrewer)
library(Matrix)
library(raster)


```


This report highlights the preliminary data analysis of the LDSF data within the project Drylands Transform - Chepareria, Lokiriama (KE) and Matany and Rupa (UG).


```{r LoadData, include=FALSE}


ldsf.chep <- as_tibble(read.csv("../Data/Field data/table_plotproperties_Chepareria_clean.csv", stringsAsFactors = TRUE))
ldsf.loki <- as_tibble(read.csv("../Data/Field data/table_plotproperties_Lokiriama_clean.csv", stringsAsFactors = TRUE))
ldsf.mata.rupa <- as_tibble(read.csv("../Data/Field data/table_plotproperties_Matany_Rupa_clean.csv", stringsAsFactors = TRUE))
ldsf.kalama <- as_tibble(read.csv("../Data/Field data/table_plotproperties_Kalama_clean.csv"), stringsAsFactors = TRUE)
ldsf.chep_LC <- as_tibble(read.csv("../Data/Field data/ldsf_plots_dt_LCs_clean.csv"), stringsAsFactors = TRUE)

colnames(ldsf.chep) <- tolower(colnames(ldsf.chep))
colnames(ldsf.loki) <- tolower(colnames(ldsf.loki))
colnames(ldsf.mata.rupa) <- tolower(colnames(ldsf.mata.rupa))
colnames(ldsf.kalama) <- tolower(colnames(ldsf.kalama))
colnames(ldsf.chep_LC) <- tolower(colnames(ldsf.chep_LC))

ldsf.DT <- bind_rows(ldsf.chep, ldsf.loki, ldsf.mata.rupa, ldsf.kalama)
ldsf.LC <- bind_rows(ldsf.chep_LC)


#Rename the site names so that it matches the ldsf.DT 
ldsf.LC$site <- gsub("Chepararia_LC", "Chepareria", ldsf.LC$site)
ldsf.LC$site <- gsub("Lokiriama_LC", "Lokiriama", ldsf.LC$site)



ldsf.LC$cluster <- ifelse(ldsf.LC$site == "Chepareria" & ldsf.LC$plot %in% c(6, 7, 8, 9, 10) & ldsf.LC$cluster == 17, 18, ldsf.LC$cluster)


```


```{r LoadDataSummary, echo=TRUE}



# Create a summary table for ldsf.DT
plots.summary_dt <- ldsf.DT %>%
  group_by(site, cluster) %>%
  summarise(Number = n()) 
knitr::kable(plots.summary_dt, digits = 2, caption = "Table 1. Number of sampled plots per cluster and site" ) %>%
  kable_styling(latex_options = c("striped", "hover", "hold_position"))

# Create a summary table for ldsf.LC
plots.summary_lc <- ldsf.LC %>%
  group_by(site, cluster) %>%
  summarise(Number = n()) 
knitr::kable(plots.summary_lc, digits = 2, caption = "Table 1. Number of sampled plots per cluster and site" ) %>%
  kable_styling(latex_options = c("striped", "hover", "hold_position"))


# Add a DataType column
ldsf.DT$DataType <- 'DT' # Marking DT rows
ldsf.LC$DataType <- 'LC' # Marking LC rows

# Combine ldsf.DT and ldsf.LC
ldsf_combined <- bind_rows(
  ldsf.DT,
  ldsf.LC
)





```




```{r leafletplotCultMgd, fig.cap="Map 1. Location of the LDSF plots and Livestock Cafe plots"}


leaflet(ldsf_combined) %>%
  addProviderTiles(provider = "Esri.WorldImagery", group = "Satelite") %>%
  addProviderTiles(provider = "CartoDB.Positron", group = "General") %>%
  addProviderTiles(provider = "OpenTopoMap", group = "Topo") %>%
  addCircleMarkers(
    data = ldsf_combined %>% filter(DataType == "DT"),
    lng = ~longitude,
    lat = ~latitude,
    radius = 2,
    stroke = TRUE,
    color = "blue", # DT plots in blue
    label = ~paste0(site, cluster, ".", plot)
  ) %>%
  addCircleMarkers(
    data = ldsf_combined %>% filter(DataType == "LC"),
    lng = ~longitude,
    lat = ~latitude,
    radius = 2,
    stroke = TRUE,
    color = "red", # LC plots in red
    label = ~paste0(site, cluster, ".", plot)
  ) %>%
  addLayersControl(baseGroups = c("General", "Topo", "Satelite"))



```




Soil erosion

erosion is the most widespread form of land degradation. In each sub-plot (n=4) per plot, signs of erosion are recorded and classified into None/Sheet/Rill/Gully.

Based on this, a visible erosion score (viserosion) is calculated by adding the subplot visible erosion variable (0 - no erosion, 1 erosion) in all 4 subplots. A severe erosion index (severeero) is also calculated (0 - no severe erosion, 1 severe erosion), with 1 meaning that viserosion >= 3. 


```{r erosionCalculations}


ldsf_combined <- ldsf_combined %>%
  mutate(
 viserosion1 = recode(erosion1, "none" = 0, .default = 1),
  viserosion2 = recode(erosion2, "none" = 0, .default = 1),
  viserosion3 = recode(erosion3, "none" = 0, .default = 1),
  viserosion4 = recode(erosion4, "none" = 0, .default = 1),
  viserosion = viserosion1 + viserosion2 + viserosion3 + viserosion4,
    severeero = ifelse(viserosion >= 3, 1, 0)
  )

#Calculate the mean of viserosion for the entire data set 
mean_vis_erosion <- mean(ldsf_combined$viserosion, na.rm = TRUE)

#Calculate the mean of viserosion for each cluster
cluster_means <- ldsf_combined %>%
  group_by(site, cluster) %>%
  summarise(Meanviserosion = mean(viserosion, na.rm = TRUE)) %>%
  ungroup()


# Calculate the prevalence of severe erosion for the entire data set 
eros.preval.cluster <- ldsf_combined %>%
  group_by(site, cluster, DataType) %>% 
  summarise(
    Totalplots = n(),
    severeerosionplots = sum(severeero == 1),
    .groups = 'drop'
  ) %>%
  mutate(Frequencysevereerosion = severeerosionplots / Totalplots)





```

```{r erosionGraphsBar, fig.cap="Percentage of plots with severe erosion per cluster", out.width="100%", fig.height=9}


ggplot(eros.preval.cluster, aes(x = factor(cluster), y = Frequencysevereerosion * 100, fill = DataType)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.75), alpha = 0.9) +
  scale_fill_manual(values = c("DT" = "#0073C2FF", "LC" = "#EFC000FF")) +
  theme_ipsum(base_size = 14) +
  labs(
    title = "Percentage of plots with Severe erosion per cluster",
    x = "cluster",
    y = "Percentage of Severe erosion",
    fill = "Data Type"
  ) +
  facet_wrap(~site, ncol=1, scales = "free_x") +
  theme(
    legend.position = "top",
    axis.text.x = element_text(angle = 0, hjust = 1, size = 12), # Rotate x-axis labels for readability
    plot.margin = margin(10, 10, 10, 10) 
  )

ggsave(file = "../Images/erosionPrevalencePercentage.jpeg",
       width = 20,
       height = 40,
       units = "cm",
       dpi = 600)

```


```{r erosionGraph, fig.cap="The plot distributions for viserosion for each cluster, with global mean and Poisson distribution", out.width="100%", fig.height=9}


# plotting the distribution of viserosion, with cluster-specific and global mean lines
ggplot(ldsf_combined, aes(x = viserosion)) +
  geom_histogram(aes(y = ..density..), binwidth = 1, color = "black", fill = "skyblue") +
  facet_grid(site ~ cluster, scales = "free") +
  labs(title = "Distribution of viserosion by cluster within sites", 
       x = "viserosion", 
       y = "Density") +
  theme_minimal() +
  geom_vline(data = cluster_means, aes(xintercept = meanviserosion), linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = mean_vis_erosion, linetype = "dashed", color = "red", size = 1) +
  geom_text(aes(x = mean_vis_erosion, y = 0, label = sprintf(" %.2f", mean_vis_erosion)), color = "red", vjust = -1, hjust = 1.1, data = data.frame(mean_vis_erosion = mean_vis_erosion)) +
  geom_text(data = cluster_means, aes(x = meanviserosion, y = 0, label = sprintf(" %.2f", meanviserosion)), color = "black", vjust = -1, hjust = 1.1)

ggsave(file = "../Images/erosionPrevalencePoissonAllclusters.jpeg",
         width = 30,
         height = 30,
         units = "cm",
         dpi = 600)




```


```{r erosionGraph, fig.cap="The plot distribution for viserosion for each cluster in Cheppareria, with mean", out.width="100%", fig.height=9}

# Filter to include only site Chepareria
ldsf_combined_cheperaria <- ldsf_combined %>%
  filter(site %in% c("Chepareria"))

# Calculate maxviserosion and mean_vis_erosion_cheperaria 
maxviserosion <- max(ldsf_combined_cheperaria$viserosion, na.rm = TRUE)
mean_vis_erosion_cheperaria <- mean(ldsf_combined_cheperaria$viserosion, na.rm = TRUE)
cluster_means_cheperaria <- ldsf_combined_cheperaria %>%
  group_by(cluster) %>%
  summarise(meanviserosion = mean(viserosion, na.rm = TRUE)) %>%
  ungroup()

# plot
if (nrow(ldsf_combined_cheperaria) > 0) {
  g <- ldsf_combined_cheperaria %>%
    ggplot(aes(x = viserosion)) +
    geom_histogram(aes(y = ..density..), binwidth = 1, fill = "skyblue", color = "black") +
    facet_wrap(~ cluster, scales = "free_y") +
    labs(x = "viserosion", y = "Density") +
    geom_vline(data = cluster_means_cheperaria, aes(xintercept = meanviserosion), linetype = "dashed", color = "black", size = 1) +
    geom_vline(xintercept = mean_vis_erosion_cheperaria, color = "red", linetype = "dashed", size = 1) +
    annotate("text", x = mean_vis_erosion_cheperaria, y = 0.9, label = sprintf("Chepareria mean: %.2f", mean_vis_erosion_cheperaria), color = "red", size = 3, hjust = 1) +
    geom_text(data = cluster_means_cheperaria, aes(x = meanviserosion, y = 0.05, label = sprintf("%.2f", meanviserosion)), color = "black", size = 3, vjust = 0, hjust = 0.5)
  
  print(g)
  
  ggsave(file = "../Images/erosionPrevalenceChepareriacluster.jpeg",
         width = 20,
         height = 40,
         units = "cm",
         dpi = 600)
} else {
  print("No data")
}





```




```{r erosionGraph, fig.cap=" Type of erosion", out.width="100%", fig.height=9}
library(tidyverse)

#FIXA SÅ ATT DET BLIR SAMMA plotTAR SOM I HERB

# Antag att ditt dataset är laddat och heter ldsf_combined_cheperari
# Om inte, ladda det här, exempel:
# ldsf_combined_cheperari <- read.csv("sökväg/till/din/fil.csv")

# Förbered data och beräkna procentandelar
ldsf_long <- ldsf_combined_cheperaria %>%
  pivot_longer(cols = starts_with("erosion"), names_to = "erosionType", values_to = "erosionValue") %>%
  group_by(cluster, erosionValue) %>%
  summarise(Count = n(), .groups = 'drop') %>%
  group_by(cluster) %>%
  mutate(Total = sum(Count), Percentage = (Count / Total) * 100) %>%
  ungroup()

# Skapa stapeldiagram för procentandelar med justerade mellanrum mellan clusterna
ggplot(ldsf_long, aes(x = as.factor(cluster), y = Percentage, fill = erosionValue)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  labs(x = "cluster", y = "Procent", fill = "erosionstyp") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```

```{r}
library(tidyverse)

# Antag att ditt dataset är laddat och heter ldsf_combined_cheperari
# Om inte, ladda det här, exempel:
# ldsf_combined_cheperari <- read.csv("sökväg/till/din/fil.csv")

# Beräkna procentandelar inklusive 'none'
ldsf_long_with_none <- ldsf_combined_cheperaria %>%
  pivot_longer(cols = starts_with("erosion"), names_to = "erosionType", values_to = "erosionValue") %>%
  count(cluster, erosionValue) %>%
  group_by(cluster) %>%
  mutate(TotalCount = sum(n), Percentage = n / TotalCount) %>%
  ungroup()

# Filtrera bort 'none' från den dataset som ska plottas
ldsf_long_for_plot <- ldsf_long_with_none %>%
  filter(erosionValue != "none")

# Skapa stapeldiagramplotten med procentandelar där fördelningen inom varje stapel är färgkodad
ldsf_erosion_plot_with_percent <- ggplot(ldsf_long_for_plot, aes(x = as.factor(cluster), y = Percentage, fill = erosionValue)) +
  geom_bar(stat = "identity", position = "stack") + # Använd position "stack" för att visa total procentandel av erosion
  scale_y_continuous(labels = scales::percent_format()) +
  labs(x = "cluster", y = "Procent av erosion", fill = "erosionstyp") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# Visa plotten
print(ldsf_erosion_plot_with_percent)


```



```{r erosionGraph, fig.cap=" The plot distribution for viserosion for cluster 7, 8 and 17", out.width="100%", fig.height=9}



# Filter the dataset to only include data for Chepareria and clusters 7, 8, and 17
ldsf_specific_clusters <- ldsf_combined %>%
  filter(site == "Chepareria", cluster %in% c(7, 8, 17))

# Calculate maxviserosion and the global mean of viserosion for the selected clusters
maxviserosion_specific <- max(ldsf_specific_clusters$viserosion, na.rm = TRUE)
mean_vis_erosion_specific <- mean(ldsf_specific_clusters$viserosion, na.rm = TRUE)

# Calculate the mean of viserosion for each of the selected clusters
cluster_means_specific <- ldsf_specific_clusters %>%
  group_by(cluster) %>%
  summarise(Meanviserosion = mean(viserosion, na.rm = TRUE)) %>%
  ungroup()

# plot
if (nrow(ldsf_specific_clusters) > 0) {
  g <- ldsf_specific_clusters %>%
    ggplot(aes(x = viserosion)) +
    geom_histogram(aes(y = ..density..), binwidth = 1, fill = "skyblue", color = "black") +
    facet_wrap(~ cluster, scales = "free_y") +
    labs(x = "viserosion", y = "Density") +
    geom_vline(data = cluster_means_specific, aes(xintercept = Meanviserosion), linetype = "dashed", color = "black", size = 1) +
    geom_vline(xintercept = mean_vis_erosion_specific, color = "red", linetype = "dashed", size = 1) +
    annotate("text", x = mean_vis_erosion_specific, y = 0.9, label = sprintf("Specific clusters mean: %.2f", mean_vis_erosion_specific), color = "red", size = 3, hjust = 1) +
    geom_text(data = cluster_means_specific, aes(x = Meanviserosion, y = 0.05, label = sprintf("%.2f", Meanviserosion)), color = "black", size = 3, vjust = 0, hjust = 0.5)

  print(g)
  
  ggsave(file = "../Images/erosionPrevalencePoissonChepareriaclusters7_8_17.jpeg",
         width = 20,
         height = 40,
         units = "cm",
         dpi = 600)
} else {
  print("No data")
}


```

```{r erosionGraph, fig.cap="Semivariagram, the whole data set", out.width="100%", fig.height=9}


# Skapa SpatialPointsDataFrame för hela datasetet
ldsf_combined_spatial <- ldsf_combined
coordinates(ldsf_combined_spatial) <- ~longitude + latitude
proj4string(ldsf_combined_spatial) <- CRS("+proj=longlat +datum=WGS84")

# Skapa SpatialPointsDataFrame för Chepareria
ldsf_combined_cheperaria_spatial <- ldsf_combined %>%
  filter(site == "Chepareria")

coordinates(ldsf_combined_cheperaria_spatial) <- ~longitude + latitude
proj4string(ldsf_combined_cheperaria_spatial) <- CRS("+proj=longlat +datum=WGS84")



```

```{r erosionGraph, fig.cap="Semivariagram, clusters in whole data set", out.width="100%", fig.height=9}


library(gstat)

# Beräkna semivariogram för hela datasetet
viserosion_variogram_total <- variogram(viserosion~1, data = ldsf_combined_spatial)

# Skapa en startmodell och anpassa en semivariogrammodell till de beräknade punkterna
# Exempel: vgm(nugget, model type, range, sill)
fit_total <- fit.variogram(viserosion_variogram_total, model = vgm(1, "Sph", 1, 1))

# plotta både de beräknade punkterna och den anpassade modellen
plot(viserosion_variogram_total, model = fit_total, main = "Semivariogram for viserosion - Whole Dataset",
     pch = 20, col = "#FF5733", cex = 2)


```

```{r erosionGraph, fig.cap="Semivariagram, clusters in Cheppeirera", out.width="100%", fig.height=9}

# Beräkna semivariogram för Chepareria
viserosion_variogram_cheperaria <- variogram(viserosion~1, data = ldsf_combined_cheperaria_spatial)

# Skapa en startmodell och anpassa en semivariogrammodell till de beräknade punkterna för Chepareria
fit_cheperaria <- fit.variogram(viserosion_variogram_cheperaria, model = vgm(1, "Sph", 1, 1))

# plotta både de beräknade punkterna och den anpassade modellen för Chepareria
plot(viserosion_variogram_cheperaria, model = fit_cheperaria, main = "Semivariogram for viserosion in Chepareria",
     pch = 20, col = "#FF5733", cex = 2)


```



```{r erosionGraph, fig.cap=" The plot distribution for viserosion for cluster 6,7, 10 and 17 Lokiriama", out.width="100%", fig.height=9}


# Filtrera för att endast inkludera site Chepareria och Lokiriama
ldsf_combined_lokiriama <- ldsf_combined %>%
  filter(site %in% c("Lokiriama"))


# Filtrera för att endast inkludera site Chepareria och Lokiriama
ldsf_lok_chep <- ldsf_combined %>%
  filter(site %in% c("Chepareria", "Lokiriama"))

ldsf_specific_clusters_lok <- ldsf_combined %>%
  filter(site == "Lokiriama", cluster %in% c(6, 7, 10, 17))


# Calculate maxviserosion and the global mean of viserosion for the selected clusters
mean_vis_erosion_specific <- mean(ldsf_specific_clusters_lok$viserosion, na.rm = TRUE)

# Calculate the mean of viserosion for each of the selected clusters
cluster_means_specific_lok <- ldsf_specific_clusters_lok %>%
  group_by(cluster) %>%
  summarise(Meanviserosion = mean(viserosion, na.rm = TRUE)) %>%
  ungroup()

# plot
g <- ldsf_specific_clusters_lok %>%
  ggplot(aes(x = viserosion)) +
  geom_histogram(aes(y = ..density..), binwidth = 1, fill = "skyblue", color = "black") +
  facet_wrap(~ cluster, scales = "free_y") +
  labs(x = "viserosion", y = "Densitet") +
  geom_vline(data = cluster_means_specific_lok, aes(xintercept = Meanviserosion), linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = mean_vis_erosion_specific, color = "red", linetype = "dashed", size = 1) +
  annotate("text", x = mean_vis_erosion_specific, y = 0.9, label = sprintf("Specifika kluster medel: %.2f", mean_vis_erosion_specific), color = "red", size = 3, hjust = 1) +
  geom_text(data = cluster_means_specific_lok, aes(x = Meanviserosion, y = 0.05, label = sprintf("%.2f", Meanviserosion)), color = "black", size = 3, vjust = 0, hjust = 0.5)

print(g)

ggsave(file = "../Images/erosionPrevalencePoissonChepareriaclusters7_8_17.jpeg",
       width = 20,
       height = 40,
       units = "cm",
       dpi = 600)


```

```{r erosionGraph, fig.cap="Semivariagram, clusters in Lokiriama", out.width="100%", fig.height=9}


# Load required library
library(sp)

# Create a copy of ldsf_combined_lokiriama
ldsf_combined_lokiriama_spatial <- ldsf_combined_lokiriama

# Set coordinates
coordinates(ldsf_combined_lokiriama_spatial) <- c("longitude", "latitude")

# Set projection
proj4string(ldsf_combined_lokiriama_spatial) <- CRS("+proj=longlat +datum=WGS84")

# Beräkna semivariogram för Lokiriama
viserosion_variogram_lok <- variogram(viserosion ~ 1, data = ldsf_combined_lokiriama_spatial)

# Skapa en startmodell och anpassa en semivariogrammodell
fit_lok <- fit.variogram(viserosion_variogram_lok, model = vgm(1, "Sph", 1, 1))

# Plotta både de beräknade punkterna och den anpassade modellen för Lokiriama
plot(viserosion_variogram_lok, model = fit_lok, main = "Semivariogram for viserosion in Lokiriama",
     pch = 20, col = "#FF5733", cex = 2)


```
```{r}
# Beräkna procentandelar inklusive 'none'
ldsf_long_with_none_lok <- ldsf_combined_lokiriama %>%
  pivot_longer(cols = starts_with("erosion"), names_to = "erosionType", values_to = "erosionValue") %>%
  count(cluster, erosionValue) %>%
  group_by(cluster) %>%
  mutate(TotalCount = sum(n), Percentage = n / TotalCount) %>%
  ungroup()

# Filtrera bort 'none' från den dataset som ska plottas
ldsf_long_for_plot_lok <- ldsf_long_with_none_lok %>%
  filter(erosionValue != "none")

# Skapa stapeldiagramplotten med procentandelar där fördelningen inom varje stapel är färgkodad
ldsf_erosion_plot_with_percent_lok <- ggplot(ldsf_long_for_plot_lok, aes(x = as.factor(cluster), y = Percentage, fill = erosionValue)) +
  geom_bar(stat = "identity", position = "stack") + # Använd position "stack" för att visa total procentandel av erosion
  scale_y_continuous(labels = scales::percent_format()) +
  labs(x = "cluster", y = "Procent av erosion", fill = "erosionstyp") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# Visa plotten
print(ldsf_erosion_plot_with_percent_lok)

```


```{r erosionGraph, fig.cap="Visible erosion score in each plot", out.width="100%", fig.height=9}



pal_ero <- colorNumeric(palette = "YlOrBr", domain = c(0:4))

leaflet() %>%
  addProviderTiles(provider="Esri.WorldImagery", group = "Satelite") %>%
  addProviderTiles(provider = "CartoDB.Positron", group = "General") %>%
  addProviderTiles(provider = "OpenTopoMap", group = "Topo") %>%
  # För kluster 17 och 18, gör ifyllda cirklar
  addCircleMarkers(
    data = ldsf_combined %>%
      filter(cluster %in% c(17, 18)),
    group = "cluster 17/18",
    lng = ~longitude,
    lat = ~latitude,
    radius = 6,
    opacity = 0.8,
    weight = 3,
    stroke = TRUE,
    fillColor = ~pal_ero(viserosion),  
    color = ~pal_ero(viserosion),
    fillOpacity = 1,
    label = ~paste0(site, " ", cluster, ".", plot)
  ) %>%
  # För alla kluster utom 17 och 18, gör cirkelmarkörer
  addCircleMarkers(
    data = ldsf_combined %>%
      filter(!cluster %in% c(17, 18)),
    group = "Other clusters",
    lng = ~longitude,
    lat = ~latitude,
    radius = 6,
    opacity = 0.8,
    weight = 3,
    stroke = TRUE,
    color = ~pal_ero(viserosion),
    label = ~paste0(site, " ", cluster, ".", plot)
  ) %>%
  addLayersControl(baseGroups = c("Satelite", "General", "Topo"),
                   overlayGroups = c("cluster 17/18", "Other clusters")) %>%
  addLegend(pal = pal_ero, values = c(0:4), position = "bottomright")


```




```{r erosionGraph, fig.cap="Figure Herbescus cover in Chepareria ", out.width="100%", fig.height=9}
library(tidyverse)
library(RColorBrewer)

# Antag att ditt dataset ldsf_lok_chep redan är laddat

# Datatransformation och ordna 'rating' i önskad sekvens
herb_cover_long <- ldsf_combined_cheperaria %>%
  pivot_longer(cols = starts_with("HerbCovRate"), names_to = "HerbCovRate", values_to = "value") %>%
  mutate(rating = case_when(
    value == 0 ~ "absent",
    value == 1 ~ "<4%",
    value == 2 ~ "4-15%",
    value == 3 ~ "15-40%",
    value == 4 ~ "40-65%",
    TRUE ~ ">65%"
  )) %>%
  mutate(rating = factor(rating, levels = c("absent", "<4%", "4-15%", "15-40%", "40-65%", ">65%")))

# Summarize the data by cluster and rating, adjust for total coverage
herb_cover_summary <- herb_cover_long %>%
  group_by(cluster, rating) %>%
  summarise(total_coverage = sum(value), .groups = 'drop') %>%
  group_by(cluster) %>%
  mutate(freq = total_coverage / sum(total_coverage))

# Skapa en anpassad färgpalett
color_palette <- colorRampPalette(c("yellow", "red"))(length(unique(herb_cover_long$rating)))

# Skapa en namngiven vektor med färger baserade på 'rating'-nivåerna
colors_for_ratings <- setNames(color_palette, levels(herb_cover_long$rating))

# Använd den anpassade färgpaletten i din plot med 'rating' i önskad ordning
herbaceous_cover_plot <- ggplot(herb_cover_summary, aes(x = rating, y = freq * 100, fill = rating)) + 
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("Percentage of Herbaceous Cover (%)") +
  xlab("Herbaceous Cover Rating (%)") +
  ggtitle("Herbaceous Cover Rating by cluster (%)") +
  facet_wrap(~cluster) +
  scale_fill_manual(values = colors_for_ratings) + # Använd den anpassade färgpaletten
  theme_gray(base_size = 10)

# Visa plotten
print(herbaceous_cover_plot)

# Spara plotten
ggsave(file = "HerbaceousCoverRatingcluster.jpeg", width = 25, height = 15, units = "cm", dpi = 600)


```
```{r loadsoildata, warning=FALSE, include=FALSE}

#soil data mir predicted

# Läs in och förbehandla soil.pred.DT
soil.pred.DT <- read.csv("../Data/Field data/ldsf_mirpred_soilvars_Dec2022.csv", stringsAsFactors = TRUE) %>%
  mutate(ldsfID = as.character(ldsfID)) %>%
  filter(site != "Kalama") %>%
  filter(Depthcode != "")

# Antaget att ldsf_lok_chep är definierad någonstans ovanför detta stycke,
# och du vill utföra en operation på den.
ldsf_combined <- ldsf_combined %>%
  mutate(ldsfID = as.character(ldsfID))



glimpse(soil.pred.DT)


glimpse(ldsf_combined)



#combine mir + ldsf

#ldsf.soil.pred.DT<- dplyr::left_join(soil.pred.DT, ldsf.DT, by = "ldsfID" )

#setdiff(ldsf.DT$ldsfID,soil.pred.DT$ldsfID) # Falten 2 mostres 

#setdiff(soil.pred.DT$ldsfID, ldsf.DT$ldsfID) 

```


```{r}
library(raster)
library(terra)

# Ersätt 'path_to_your_file.tif' med sökvägen till din .tif-fil
rasterLayer <- rast("../Data/Field data/Maps/Chep_2020_2024.tif")

# För att visa datan
plot(rasterLayer)
plot()
```



```{r erosionGraph, fig.cap="Mixed effetcts model ", out.width="100%", fig.height=9}
mod.erosion <- glmer(severeero~1+(1|site/cluster),family="binomial", data=ldsf_combined)
summary(mod.erosion)
coef(mod.erosion)

```

```{r}
mod.erosion.herb <- glmer(severeero~rating+(rating|cluster),family="binomial", data=herb_cover_long)
coef(mod.erosion.herb)
summary(mod.erosion.herb)
```

